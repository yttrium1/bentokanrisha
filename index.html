<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼å½“ åœ¨åº«ç®¡ç†ãƒ»å—ã‘å–ã‚Šã‚µãƒ¼ãƒ“ã‚¹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .soft-shadow {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        .soft-shadow:hover {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        .btn {
            transition: all 0.2s ease;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pulse {
            animation: pulse-animation 2s infinite;
        }
        @keyframes pulse-animation {
            0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
            100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
        }
        .tab-btn.active {
            background-color: #6366f1;
            color: white;
            border-color: #e5e7eb;
        }
        .tab-btn {
             background-color: #f3f4f6;
             color: #374151;
             border-color: transparent;
        }
        /* Modal styles */
        .modal-enter {
            opacity: 0;
            transform: scale(0.95);
        }
        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }
        .modal-leave {
            opacity: 1;
            transform: scale(1);
        }
        .modal-leave-active {
            opacity: 0;
            transform: scale(0.95);
            transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }
        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        input[type=number] {
          -moz-appearance: textfield;
        }
        /* Card Shuffle Animation */
        .lottery-card {
            width: 100px;
            height: 140px;
            perspective: 1000px;
            transition: transform 0.5s;
        }
        .lottery-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .lottery-card.flipped .lottery-card-inner {
            transform: rotateY(180deg);
        }
        .lottery-card-front, .lottery-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
        }
        .lottery-card-front {
            background-color: #6366f1;
            color: white;
            font-size: 2rem;
            font-weight: bold;
        }
        .lottery-card-back {
            background-color: white;
            color: black;
            transform: rotateY(180deg);
            flex-direction: column;
        }
        .winner-card .lottery-card-back {
            background: linear-gradient(45deg, #fde047, #f97316);
        }
        /* Joker Effect */
        @keyframes joker-glow {
            0% { box-shadow: 0 0 5px #a855f7, 0 0 10px #a855f7, 0 0 15px #a855f7; }
            50% { box-shadow: 0 0 20px #d8b4fe, 0 0 30px #d8b4fe, 0 0 40px #d8b4fe; }
            100% { box-shadow: 0 0 5px #a855f7, 0 0 10px #a855f7, 0 0 15px #a855f7; }
        }
        .joker-flash {
            animation: joker-glow 0.5s ease-in-out 3;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">

        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">å¼å½“æŒ¯åˆ†</h1>
            <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mt-4 text-left text-sm" role="alert">
                <p class="font-bold">èª¬æ˜</p>
                <p>èª¬æ˜ä¼šçµ‚äº†1æ™‚é–“ä»¥å†…ã«æŠ•ç¥¨ãŠé¡˜ã„ã—ã¾ã™ã€‚æœªæŠ•ç¥¨è€…ã¯å¸Œæœ›ã—ãªã„ã‚‚ã®ã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚å½“é¸è€…ã¯å®Ÿéš›ã«æŒã¡å¸°ã£ãŸã‚‰ã€ãƒœã‚¿ãƒ³ã‚’ãŠã—ã¦ãã ã•ã„ã€‚2ãƒ¶æœˆã«1å›ã ã‘å½“é¸ç¢ºç‡ãŒ10å€ã«ãªã‚‹JOKERã‚’ä½¿ãˆã¾ã™ã€‚</p>
            </div>
        </header>

        <!-- Tab Navigation -->
        <div class="mb-8">
            <div class="flex border-b border-gray-200">
                <button id="user-tab" class="tab-btn active py-2 px-6 font-medium text-sm rounded-t-lg border-b-2 focus:outline-none">åˆ©ç”¨è€…ç”»é¢</button>
                <button id="admin-tab" class="tab-btn py-2 px-6 font-medium text-sm rounded-t-lg border-b-2 focus:outline-none">ç®¡ç†è€…ç”»é¢</button>
            </div>
        </div>

        <!-- User View -->
        <div id="user-view">
             <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- å·¦ã‚«ãƒ©ãƒ ï¼šåœ¨åº«ã¨æ„æ€è¡¨ç¤º -->
                <div class="lg:col-span-2">
                    <!-- åœ¨åº«æƒ…å ± -->
                    <div id="bento-info-card" class="bg-white p-6 rounded-xl soft-shadow mb-8">
                        <h2 class="text-2xl font-bold text-gray-900 mb-2" id="current-bento-name">å¼å½“ã¯ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</h2>
                        <div class="flex items-baseline">
                            <p class="text-5xl font-extrabold text-indigo-600" id="current-bento-stock">0</p>
                            <p class="ml-2 text-xl text-gray-600">å€‹</p>
                        </div>
                    </div>

                    <!-- æ„æ€è¡¨ç¤ºãƒ‘ãƒãƒ« -->
                    <div class="bg-white p-6 rounded-xl soft-shadow">
                        <p id="system-message" class="text-sm text-center p-3 mb-4 bg-yellow-100 text-yellow-800 rounded-lg">å¼å½“ãŒç™»éŒ²ã•ã‚Œã‚‹ã¨æ„æ€è¡¨ç¤ºã‚’é–‹å§‹ã§ãã¾ã™ã€‚</p>
                        <div id="wish-list" class="space-y-3">
                            <!-- JSã§ç¤¾å“¡ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>

                <!-- å³ã‚«ãƒ©ãƒ ï¼šç¢ºå®šè€…ã¨å±¥æ­´ -->
                <div>
                    <!-- JOKER Status -->
                     <div class="bg-white p-6 rounded-xl soft-shadow mb-8">
                        <h3 class="text-xl font-bold mb-4">ğŸƒ JOKERæ‰€æŒçŠ¶æ³</h3>
                        <div id="joker-status-list" class="space-y-2">
                            <!-- JSã§JOKERçŠ¶æ³ã‚’ç”Ÿæˆ -->
                        </div>
                    </div>

                    <!-- ç¢ºå®šè€…ãƒªã‚¹ãƒˆ -->
                    <div class="bg-white p-6 rounded-xl soft-shadow mb-8">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">ğŸ‰ æœ¬æ—¥ã®å¼å½“GETçµ„</h3>
                            <button id="replay-roulette-btn" class="hidden bg-gray-200 text-gray-700 text-xs font-bold py-1 px-2 rounded-md hover:bg-gray-300 btn flex items-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7V9a1 1 0 01-2 0V3a1 1 0 011-1zm12 1a1 1 0 011 1v6a1 1 0 01-2 0V9.899a7.002 7.002 0 01-11.601-2.566 1 1 0 111.885-.666A5.002 5.002 0 0014.001 13V11a1 1 0 012 0v6a1 1 0 01-1 1H9a1 1 0 110-2h4.001v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 111.885-.666A5.002 5.002 0 0014.001 7V9a1 1 0 012 0V3a1 1 0 01-1-1h4z" clip-rule="evenodd" />
                                </svg>
                                å†ç”Ÿ
                            </button>
                        </div>
                        <div id="takers-list" class="space-y-3">
                            <p class="text-gray-500">ã¾ã èª°ã‚‚ç¢ºå®šã—ã¦ã„ã¾ã›ã‚“ã€‚</p>
                        </div>
                    </div>
                </div>
            </div>
             <!-- Past Bento Popularity -->
            <div class="bg-white p-6 rounded-xl soft-shadow mt-8">
                <h3 class="text-xl font-bold mb-4">ğŸ† å¼å½“ç²å¾—ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
                <div id="stats-list" class="space-y-2 mb-6">
                    <!-- JSã§ç´¯è¨ˆæ•°ã‚’ç”Ÿæˆ -->
                </div>
                <h3 class="text-xl font-bold mb-4 border-t pt-4">å—ã‘å–ã‚Šå±¥æ­´</h3>
                <div id="history-list" class="space-y-2 text-sm max-h-48 overflow-y-auto">
                        <p class="text-gray-500">ã¾ã å—ã‘å–ã‚Šå±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                </div>
            </div>
        </div>
        
        <!-- Admin View -->
        <div id="admin-view" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <!-- ç®¡ç†è€…ç”¨ãƒ‘ãƒãƒ« -->
                    <div class="bg-white p-6 rounded-xl soft-shadow mb-8">
                        <h2 class="text-xl font-bold mb-4 border-b pb-2">å¼å½“ã®ç™»éŒ²ãƒ»ãƒªã‚»ãƒƒãƒˆ</h2>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 items-end">
                            <div>
                                <label for="bento-name" class="block text-sm font-medium text-gray-700">å¼å½“ã®åå‰</label>
                                <input type="text" id="bento-name" class="mt-1 block w-full rounded-md border-gray-200 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                            </div>
                            <div>
                                <label for="bento-stock" class="block text-sm font-medium text-gray-700">å…¥è·å€‹æ•°</label>
                                <input type="number" id="bento-stock" class="mt-1 block w-full rounded-md border-gray-200 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                            </div>
                            <button id="register-bento-btn" class="w-full bg-indigo-500 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 btn">
                                ç™»éŒ²ãƒ»ãƒªã‚»ãƒƒãƒˆ
                            </button>
                        </div>
                         <p class="text-xs text-gray-500 mt-2">â€» ç™»éŒ²ãƒ»ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ç¾åœ¨ã®æ„æ€è¡¨ç¤ºã‚„ç¢ºå®šè€…ãƒªã‚¹ãƒˆãŒã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚</p>
                    </div>
                    
                    <!-- å±¥æ­´æ¶ˆå»ãƒ‘ãƒãƒ« -->
                     <div class="bg-white p-6 rounded-xl soft-shadow">
                        <h2 class="text-xl font-bold mb-4 border-b pb-2 text-red-600">å±é™ºãªæ“ä½œ</h2>
                        <div class="flex items-center justify-between mb-4">
                             <div>
                                <h3 class="font-bold">äººæ°—æŠ•ç¥¨ã®å±¥æ­´ã‚’æ¶ˆå»</h3>
                                <p class="text-sm text-gray-600 mt-1">äººæ°—æŠ•ç¥¨ã®å±¥æ­´ã®ã¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚<br>ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚„å€‹äººã®ç²å¾—å±¥æ­´ã¯æ®‹ã‚Šã¾ã™ã€‚</p>
                            </div>
                            <button id="clear-popularity-history-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 btn">
                                å±¥æ­´æ¶ˆå»
                            </button>
                        </div>
                        <div class="flex items-center justify-between border-t pt-4">
                             <div>
                                <h3 class="font-bold">å…¨JOKERã‚’ãƒªã‚»ãƒƒãƒˆ</h3>
                                <p class="text-sm text-gray-600 mt-1">å…¨å“¡ã®JOKERã‚’1æšã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚</p>
                            </div>
                            <button id="reset-jokers-btn" class="bg-amber-500 text-white font-bold py-2 px-4 rounded-md hover:bg-amber-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 btn">
                                JOKERãƒªã‚»ãƒƒãƒˆ
                            </button>
                        </div>
                    </div>
                </div>
                 <!-- æ„æ€è¡¨ç¤ºçŠ¶æ³ãƒ‘ãƒãƒ« (ç®¡ç†è€…ç”¨) -->
                <div class="bg-white p-6 rounded-xl soft-shadow">
                    <h2 class="text-xl font-bold mb-4 border-b pb-2">ç¾åœ¨ã®æ„æ€è¡¨ç¤ºçŠ¶æ³</h2>
                    <div id="admin-wish-list" class="space-y-3">
                        <!-- Admin wish list generated here -->
                    </div>
                </div>
            </div>
            <!-- Past Bento Popularity -->
            <div class="bg-white p-6 rounded-xl soft-shadow mt-8">
                <h3 class="text-xl font-bold mb-4">éå»ã®å¼å½“äººæ°—æŠ•ç¥¨ (ç®¡ç†è€…ç”¨)</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="bg-gray-50 border-b border-gray-200">
                                <th class="py-2 px-4 text-sm font-medium text-gray-600">æ—¥ä»˜</th>
                                <th class="py-2 px-4 text-sm font-medium text-gray-600">å¼å½“ã®ç¨®é¡</th>
                                <th class="py-2 px-4 text-sm font-medium text-gray-600 text-center">å¸Œæœ›è€…æ•°</th>
                                <th class="py-2 px-4 text-sm font-medium text-gray-600 text-center">JOKERä½¿ç”¨è€…æ•°</th>
                            </tr>
                        </thead>
                        <tbody id="admin-bento-history-table-body">
                           <!-- JSã§å±¥æ­´ã‚’ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <footer class="text-center mt-12 text-sm text-gray-500">
            <p>&copy; <span id="year"></span> ç¤¾å†…å¼å½“ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </p>
        </footer>
    </div>
    
    <!-- Notification Modal -->
    <div id="custom-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center">
        <div id="modal-content" class="relative mx-auto p-5 border w-11/12 md:max-w-md shadow-lg rounded-md bg-white modal-enter">
            <div class="mt-3 text-center">
                <div id="modal-icon-container" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100">
                    <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <h3 id="modal-title" class="text-lg leading-6 font-medium text-gray-900 mt-4">é€šçŸ¥</h3>
                <div class="mt-2 px-7 py-3">
                    <p id="modal-message" class="text-sm text-gray-600"></p>
                </div>
                <div id="modal-buttons" class="items-center px-4 py-3">
                    <button id="modal-ok-btn" class="px-4 py-2 bg-indigo-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-300">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Passcode Modal -->
    <div id="passcode-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center">
        <div class="relative mx-auto p-5 border w-11/12 md:max-w-sm shadow-lg rounded-md bg-white modal-enter">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-indigo-100">
                     <svg class="h-6 w-6 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 1 0-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z" />
                    </svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4">ç®¡ç†è€…ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500 mb-4">4æ¡ã®ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                    <input type="text" id="passcode-input" class="text-center text-3xl tracking-[0.5em] w-full bg-gray-100 rounded-md p-2" inputmode="numeric" pattern="[0-9]*" maxlength="4" />
                    <p id="passcode-error" class="text-red-500 text-sm h-4 mt-2"></p>
                </div>
                <div class="items-center px-4 py-3">
                     <div class="flex gap-4">
                        <button id="passcode-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button id="passcode-submit-btn" class="px-4 py-2 bg-indigo-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-300">æ±ºå®š</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Lottery Modal -->
    <div id="lottery-modal" class="fixed inset-0 bg-gray-800 bg-opacity-90 hidden z-50 flex items-center justify-center p-4">
         <div class="relative mx-auto p-6 w-full max-w-2xl text-center">
             <h3 id="lottery-title" class="text-3xl font-bold text-white mb-4">é‹å‘½ã®æŠ½é¸ï¼</h3>
             <p id="lottery-message" class="text-yellow-300 mt-2 mb-6">çµæœç™ºè¡¨ï¼</p>
             <div id="lottery-cards" class="flex flex-wrap gap-4 justify-center">
                <!-- Cards will be generated here -->
             </div>
        </div>
    </div>


    <script type="module">
        // Firebase ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, writeBatch, runTransaction, getDocs, addDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";
        
        // ã‚ãªãŸã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã®Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyD6atYGL6U4a6-20qz_g1NCmRKwfA8aEds",
            authDomain: "bento-app-2025.firebaseapp.com",
            projectId: "bento-app-2025",
            storageBucket: "bento-app-2025.appspot.com",
            messagingSenderId: "157224537828",
            appId: "1:157224537828:web:a8388a63eff8e451bba6f1",
            measurementId: "G-PBBMCG5L3Y"
        };

        // ã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'bento-app-default';

        // --- å®šæ•°å®šç¾© ---
        const MEMBERS = [
            { id: 'kono', name: 'æ²³é‡å…ˆç”Ÿ', priority: 1, weight: Math.sqrt(29) },
            { id: 'matsumura', name: 'æ¾æ‘å…ˆç”Ÿ', priority: 2, weight: Math.sqrt(17) },
            { id: 'suzuki', name: 'éˆ´æœ¨å…ˆç”Ÿ', priority: 3, weight: Math.sqrt(14) },
            { id: 'ito', name: 'ä¼Šè—¤å…ˆç”Ÿ', priority: 4, weight: Math.sqrt(10) },
            { id: 'hori', name: 'å €å…ˆç”Ÿ', priority: 5, weight: Math.sqrt(6) },
            { id: 'kasuga', name: 'æ˜¥æ—¥å…ˆç”Ÿ', priority: 6, weight: Math.sqrt(5) },
            { id: 'miyake', name: 'ä¸‰å®…å…ˆç”Ÿ', priority: 7, weight: Math.sqrt(3) },
        ];
        const ADMIN_PASSCODE = '1322';

        // --- DOMè¦ç´  ---
        let userTab, adminTab, userView, adminView, bentoNameInput, bentoStockInput, registerBentoBtn, 
            clearPopularityHistoryBtn, resetJokersBtn, currentBentoName, currentBentoStock, 
            wishList, adminWishList, takersList, statsList, historyList, bentoHistoryTableBody, 
            systemMessage, bentoInfoCard, replayRouletteBtn, jokerStatusList, customModal, 
            modalContent, modalTitle, modalMessage, modalButtons, modalIconContainer, 
            passcodeModal, passcodeInput, passcodeError, passcodeSubmitBtn, passcodeCancelBtn,
            lotteryModal, lotteryTitle, lotteryMessage, lotteryCards, adminBentoHistoryTableBody;

        // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
        let currentBento = null;
        let wishes = new Map();
        let takers = new Map();
        let jokers = new Map();
        let determinationInProgress = false;
        let isAdminAuthenticated = false;
        let isLotteryRunning = false;


        // --- Firestoreã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å‚ç…§ ---
        const bentoDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'bento/current');
        const wishesCol = collection(db, 'artifacts', appId, 'public', 'data', 'wishes');
        const takersCol = collection(db, 'artifacts', appId, 'public', 'data', 'takers');
        const statsCol = collection(db, 'artifacts', appId, 'public', 'data', 'stats');
        const historyCol = collection(db, 'artifacts', appId, 'public', 'data', 'history');
        const jokersCol = collection(db, 'artifacts', appId, 'public', 'data', 'jokers');
        const bentoHistoryCol = collection(db, 'artifacts', appId, 'public', 'data', 'bentoHistory');

        // --- ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢æ•° ---
        function showModal(message) {
            modalTitle.textContent = 'é€šçŸ¥';
            modalMessage.textContent = message;
            modalIconContainer.innerHTML = `<svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
            modalIconContainer.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100';
            
            modalButtons.innerHTML = `<button id="modal-ok-btn" class="px-4 py-2 bg-indigo-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-300">OK</button>`;
            document.getElementById('modal-ok-btn').addEventListener('click', hideModal);

            customModal.classList.remove('hidden');
            modalContent.classList.remove('modal-leave', 'modal-leave-active');
            modalContent.classList.add('modal-enter-active');
        }

        function showConfirmationModal(message, onConfirm) {
            modalTitle.textContent = 'ç¢ºèª';
            modalMessage.textContent = message;
            modalIconContainer.innerHTML = `<svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>`;
            modalIconContainer.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100';
            
            modalButtons.innerHTML = `
                <div class="flex gap-4">
                    <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button id="modal-confirm-btn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500">å®Ÿè¡Œã™ã‚‹</button>
                </div>
            `;
            document.getElementById('modal-cancel-btn').addEventListener('click', hideModal);
            document.getElementById('modal-confirm-btn').addEventListener('click', () => {
                hideModal();
                onConfirm();
            });

            customModal.classList.remove('hidden');
            modalContent.classList.remove('modal-leave', 'modal-leave-active');
            modalContent.classList.add('modal-enter-active');
        }

        function hideModal() {
            modalContent.classList.remove('modal-enter-active');
            modalContent.classList.add('modal-leave-active');
            setTimeout(() => {
                customModal.classList.add('hidden');
            }, 300);
        }

        function showPasscodeModal() {
            passcodeModal.classList.remove('hidden');
            passcodeInput.value = '';
            passcodeError.textContent = '';
            passcodeInput.focus();
        }

        function hidePasscodeModal() {
            passcodeModal.classList.add('hidden');
        }


        // --- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼è¨­å®š ---
        function setupRealtimeListeners() {
            onSnapshot(bentoDocRef, (docSnap) => {
                const oldBentoData = currentBento;
                if (docSnap.exists()) {
                    currentBento = { id: docSnap.id, ...docSnap.data() };
                    updateBentoInfoUI();

                    if (!oldBentoData || oldBentoData.timestamp?.seconds !== currentBento.timestamp?.seconds) {
                         bentoInfoCard.classList.add('pulse');
                         setTimeout(() => bentoInfoCard.classList.remove('pulse'), 2000);
                    }

                    if (currentBento.lotteryCompleted) {
                        replayRouletteBtn.classList.remove('hidden');
                    } else {
                        replayRouletteBtn.classList.add('hidden');
                    }
                } else {
                    currentBento = null;
                    resetUI();
                }
                updateWishListUI();
                updateAdminWishListUI();
            });

            onSnapshot(wishesCol, (snapshot) => {
                wishes.clear();
                snapshot.docs.forEach(doc => wishes.set(doc.id, doc.data()));
                updateWishListUI();
                updateAdminWishListUI();
                determineTakers();
            });

            onSnapshot(takersCol, (snapshot) => {
                takers.clear();
                snapshot.docs.forEach(doc => takers.set(doc.id, doc.data()));
                updateTakersListUI();
            });
            
            onSnapshot(statsCol, (snapshot) => {
                const stats = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                if(statsList) updateStatsListUI(stats);
            });

            onSnapshot(historyCol, (snapshot) => {
                const history = snapshot.docs.map(doc => doc.data()).sort((a,b) => b.timestamp.toMillis() - a.timestamp.toMillis());
                if(historyList) updateHistoryListUI(history);
            });

            onSnapshot(jokersCol, (snapshot) => {
                jokers.clear();
                snapshot.docs.forEach(doc => jokers.set(doc.id, doc.data()));
                updateJokerStatusUI();
                updateWishListUI(); // JOKER status might affect buttons
            });

            onSnapshot(query(bentoHistoryCol, orderBy("date", "desc")), (snapshot) => {
                 const history = snapshot.docs.map(doc => doc.data());
                 if(bentoHistoryTableBody) updateBentoHistoryTable(history, bentoHistoryTableBody);
                 if(adminBentoHistoryTableBody) updateBentoHistoryTable(history, adminBentoHistoryTableBody);
            });
        }

        // --- UIæ›´æ–°é–¢æ•° ---
        function updateBentoInfoUI() {
            if (currentBento) {
                currentBentoName.textContent = currentBento.name;
                currentBentoStock.textContent = currentBento.current_stock;
            }
        }
        
        function resetUI() {
            currentBentoName.textContent = 'å¼å½“ã¯ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“';
            currentBentoStock.textContent = '0';
            systemMessage.textContent = 'å¼å½“ãŒç™»éŒ²ã•ã‚Œã‚‹ã¨æ„æ€è¡¨ç¤ºã‚’é–‹å§‹ã§ãã¾ã™ã€‚';
            systemMessage.classList.replace('bg-green-100', 'bg-yellow-100');
            systemMessage.classList.replace('text-green-800', 'text-yellow-800');
            wishList.innerHTML = '';
            adminWishList.innerHTML = '<p class="text-gray-500">å¼å½“ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>';
            takersList.innerHTML = '<p class="text-gray-500">ã¾ã èª°ã‚‚ç¢ºå®šã—ã¦ã„ã¾ã›ã‚“ã€‚</p>';
            replayRouletteBtn.classList.add('hidden');
        }
        
        function updateJokerStatusUI(){
            if(!jokerStatusList) return;
            jokerStatusList.innerHTML = '';
            MEMBERS.forEach(member => {
                 const jokerData = jokers.get(member.id);
                 const hasJoker = (jokerData?.count ?? 1) > 0;
                 const div = document.createElement('div');
                 div.className = 'flex justify-between items-center text-sm';
                 div.innerHTML = `
                    <span>${member.name}</span>
                    <span class="font-bold ${hasJoker ? 'text-green-600' : 'text-gray-400'}">${hasJoker ? 'æ‰€æŒ' : 'ãªã—'}</span>
                 `;
                 jokerStatusList.appendChild(div);
            });
        }

        function updateWishListUI() {
            if(!wishList) return;
            wishList.innerHTML = '';
            const areTakersDecided = takers.size > 0;
            const noBento = !currentBento || currentBento.current_stock <= 0;

            MEMBERS.forEach(member => {
                const wishData = wishes.get(member.id);
                const li = document.createElement('div');
                li.id = `wish-item-${member.id}`;
                li.className = `p-3 rounded-lg flex items-center justify-between transition`;

                let statusHtml = '';
                let buttonHtml = '';

                if (wishData) {
                    li.classList.add('bg-gray-200');
                    statusHtml = `<span class="text-sm font-bold text-gray-700">è¡¨æ˜æ¸ˆã¿</span>`;
                } else {
                    li.classList.add('bg-gray-100');
                }

                if (!wishData && !areTakersDecided && !noBento) {
                    const twoMonths = 2 * 30 * 24 * 60 * 60 * 1000;
                    const jokerData = jokers.get(member.id);
                    const lastUsed = jokerData?.lastUsed?.toDate() ?? new Date(0);
                    const canUseJoker = (new Date() - lastUsed) > twoMonths;
                    
                    const jokerButtonHtml = canUseJoker
                        ? `<button data-id="${member.id}" class="joker-btn bg-violet-500 text-white text-sm font-bold py-1 px-3 rounded-full hover:bg-violet-600 btn">JOKERã‚’ä½¿ã†</button>`
                        : `<button class="bg-gray-400 text-white text-sm font-bold py-1 px-3 rounded-full btn" disabled title="ä½¿ç”¨æ¸ˆã¿">JOKER</button>`;

                    buttonHtml = `
                        <div class="flex flex-wrap gap-2 justify-end">
                            <button data-id="${member.id}" class="wish-btn bg-teal-500 text-white text-sm font-bold py-1 px-2 rounded-full hover:bg-teal-600 btn">å¸Œæœ›</button>
                             ${jokerButtonHtml}
                            <button data-id="${member.id}" class="leftover-btn bg-gray-400 text-white text-sm font-bold py-1 px-2 rounded-full hover:bg-gray-500 btn">ä½™ã‚Šå¸Œæœ›</button>
                            <button data-id="${member.id}" class="no-wish-btn bg-slate-400 text-white text-sm font-bold py-1 px-2 rounded-full hover:bg-slate-500 btn">ä¸è¦</button>
                        </div>
                    `;
                }

                li.innerHTML = `
                    <span class="font-medium">${member.name}</span>
                    <div class="flex-grow"></div>
                    ${statusHtml}
                    ${buttonHtml}
                `;
                wishList.appendChild(li);
            });
        }
        
        function updateAdminWishListUI() {
            if(!adminWishList) return;
            adminWishList.innerHTML = '';
            
            if (!currentBento) {
                adminWishList.innerHTML = '<p class="text-gray-500">å¼å½“ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>';
                return;
            }

            MEMBERS.forEach(member => {
                const wishData = wishes.get(member.id);
                const li = document.createElement('div');
                li.className = `p-3 rounded-lg flex items-center justify-between transition`;
                let statusHtml = '<span class="text-sm text-gray-400">æœªè¡¨æ˜</span>';

                if (wishData) {
                     if (wishData.status === 'wishing') {
                        li.classList.add('bg-blue-100');
                        statusHtml = `<span class="text-sm font-bold text-blue-600">${wishData.jokerUsed ? 'JOKERå¸Œæœ›' : 'å¸Œæœ›'}</span>`;
                    } else if (wishData.status === 'leftover') {
                        li.classList.add('bg-yellow-100');
                        statusHtml = `<span class="text-sm font-bold text-yellow-700">ä½™ã‚Šå¸Œæœ›</span>`;
                    } else if (wishData.status === 'not_wishing') {
                        li.classList.add('bg-gray-200');
                        statusHtml = `<span class="text-sm font-bold text-gray-500">ä¸è¦</span>`;
                    }
                } else {
                    li.classList.add('bg-gray-50');
                }

                li.innerHTML = `
                    <span class="font-medium">${member.name}</span>
                    ${statusHtml}
                `;
                adminWishList.appendChild(li);
            });
        }
        
        function updateTakersListUI() {
            if(!takersList) return;
            takersList.innerHTML = '';
            if (takers.size === 0) {
                takersList.innerHTML = '<p class="text-gray-500">ã¾ã èª°ã‚‚ç¢ºå®šã—ã¦ã„ã¾ã›ã‚“ã€‚</p>';
                return;
            }

            const sortedTakers = Array.from(takers.entries()).sort((a,b) => a[1].priority - b[1].priority);
            
            sortedTakers.forEach(([id, takerData]) => {
                const div = document.createElement('div');
                let statusOrButtonHtml = '';

                if (takerData.taken) {
                    div.className = 'p-3 rounded-lg flex items-center justify-between bg-green-100 text-gray-800';
                    statusOrButtonHtml = `<span class="text-sm font-bold text-green-800">å—ã‘å–ã‚Šå®Œäº†</span>`;
                } else {
                    div.className = 'p-3 rounded-lg flex items-center justify-between bg-yellow-100';
                    statusOrButtonHtml = `<button data-id="${id}" class="take-btn bg-sky-500 text-white text-sm font-bold py-1 px-3 rounded-full hover:bg-sky-600 btn">æœªå—ã‘å–ã‚Š</button>`;
                }

                div.innerHTML = `
                    <div>
                        <span class="font-bold text-gray-800">${takerData.name}</span>
                    </div>
                    ${statusOrButtonHtml}
                `;
                takersList.appendChild(div);
            });
        }

        function updateStatsListUI(stats) {
            if(!statsList) return;
            statsList.innerHTML = '';
            if (!stats || stats.length === 0) {
                 statsList.innerHTML = '<p class="text-gray-500">ã¾ã èª°ã‚‚å—ã‘å–ã£ã¦ã„ã¾ã›ã‚“ã€‚</p>';
                 return;
            }

            const sortedStats = stats.sort((a,b) => b.total_taken - a.total_taken);
            sortedStats.forEach(stat => {
                 const member = MEMBERS.find(m => m.id === stat.id);
                 if (member) {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center text-sm';
                    div.innerHTML = `
                        <span>${member.name}</span>
                        <span class="font-bold bg-indigo-100 text-indigo-800 px-2 py-0.5 rounded-full">${stat.total_taken} å›</span>
                    `;
                    statsList.appendChild(div);
                }
            });
        }
        
        function updateHistoryListUI(history) {
             if(!historyList) return;
             historyList.innerHTML = '';
             if (!history || history.length === 0) {
                 historyList.innerHTML = '<p class="text-gray-500">ã¾ã å—ã‘å–ã‚Šå±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                 return;
             }
             history.forEach(item => {
                const div = document.createElement('div');
                div.className = 'p-1.5 bg-gray-50 rounded';
                const date = item.timestamp.toDate().toLocaleString('ja-JP');
                div.textContent = `${date}: ${item.name}ãŒ${item.bento_name}ã‚’å—ã‘å–ã‚Š`;
                historyList.appendChild(div);
             });
        }
        
        function updateBentoHistoryTable(history, tableBody) {
            if(!tableBody) return;
            tableBody.innerHTML = ''; // Clear existing rows
            if (history.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500 py-4">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>';
                return;
            }

            history.forEach(item => {
                const date = item.date.toDate();
                const formattedDate = `${date.getFullYear()}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}`;
                const row = `
                    <tr class="border-b border-gray-200">
                        <td class="py-3 px-4 text-sm">${formattedDate}</td>
                        <td class="py-3 px-4 text-sm">${item.name}</td>
                        <td class="py-3 px-4 text-center text-sm">${item.wisherCount}</td>
                        <td class="py-3 px-4 text-center text-sm">${item.jokerUserCount}</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }


        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ© ---
        
        function setupEventListeners() {
            // Tab switching
            userTab.addEventListener('click', () => {
                userView.classList.remove('hidden');
                adminView.classList.add('hidden');
                userTab.classList.add('active');
                adminTab.classList.remove('active');
            });

            adminTab.addEventListener('click', () => {
                if (isAdminAuthenticated) {
                    adminView.classList.remove('hidden');
                    userView.classList.add('hidden');
                    adminTab.classList.add('active');
                    userTab.classList.remove('active');
                } else {
                    showPasscodeModal();
                }
            });

            // Passcode modal
            passcodeSubmitBtn.addEventListener('click', () => {
                if (passcodeInput.value === ADMIN_PASSCODE) {
                    isAdminAuthenticated = true;
                    hidePasscodeModal();
                    adminTab.click();
                } else {
                    passcodeError.textContent = 'ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚';
                    passcodeInput.value = '';
                    passcodeInput.focus();
                }
            });

            passcodeCancelBtn.addEventListener('click', hidePasscodeModal);
            
            passcodeInput.addEventListener('input', () => {
                passcodeError.textContent = '';
                if (passcodeInput.value.length === 4) {
                    passcodeSubmitBtn.click();
                }
            });

            // Register bento
            registerBentoBtn.addEventListener('click', async () => {
                const name = bentoNameInput.value.trim();
                const stock = parseInt(bentoStockInput.value, 10);

                if (!name || isNaN(stock) || stock <= 0) {
                    showModal('æœ‰åŠ¹ãªå¼å½“ã®åå‰ã¨å€‹æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                
                try {
                    if (currentBento && wishes.size > 0) {
                        const wisherCount = Array.from(wishes.values()).filter(w => w.status === 'wishing').length;
                        const jokerUserCount = Array.from(wishes.values()).filter(w => w.jokerUsed).length;
                        
                        const historyData = {
                            name: currentBento.name,
                            date: currentBento.timestamp,
                            wisherCount: wisherCount,
                            jokerUserCount: jokerUserCount
                        };
                        
                        await addDoc(bentoHistoryCol, historyData);
                    }

                    const batch = writeBatch(db);
                    const wishesSnapshot = await getDocs(wishesCol);
                    wishesSnapshot.forEach(doc => batch.delete(doc.ref));
                    const takersSnapshot = await getDocs(takersCol);
                    takersSnapshot.forEach(doc => batch.delete(doc.ref));
                    
                    const newBentoData = {
                        name: name,
                        initial_stock: stock,
                        current_stock: stock,
                        timestamp: new Date(),
                        lotteryCompleted: false,
                        lotteryApplicants: [],
                        lotteryWinners: []
                    };
                    batch.set(bentoDocRef, newBentoData);

                    await batch.commit();
                    
                    bentoNameInput.value = '';
                    bentoStockInput.value = '';
                    showModal(`${name}ã‚’${stock}å€‹ã§ç™»éŒ²ã—ã¾ã—ãŸã€‚`);
                } catch (error) {
                    console.error("å¼å½“ç™»éŒ²ã‚¨ãƒ©ãƒ¼:", error);
                    showModal("å¼å½“ã®ç™»éŒ²ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
                }
            });

            // Clear Popularity history
            clearPopularityHistoryBtn.addEventListener('click', () => {
                showConfirmationModal('æœ¬å½“ã«äººæ°—æŠ•ç¥¨ã®å±¥æ­´ã‚’å…¨ã¦æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚„å€‹äººã®ç²å¾—å±¥æ­´ã¯æ®‹ã‚Šã¾ã™ã€‚', async () => {
                    clearPopularityHistoryBtn.disabled = true;
                    
                    try {
                        const batch = writeBatch(db);
                        const bentoHistorySnapshot = await getDocs(bentoHistoryCol);
                        bentoHistorySnapshot.forEach(doc => batch.delete(doc.ref));
                        await batch.commit();
                        showModal('äººæ°—æŠ•ç¥¨ã®å±¥æ­´ãŒæ¶ˆå»ã•ã‚Œã¾ã—ãŸã€‚');
                    } catch (error) {
                        console.error("äººæ°—æŠ•ç¥¨å±¥æ­´ã®æ¶ˆå»ã«å¤±æ•—ã—ã¾ã—ãŸ: ", error);
                        showModal('äººæ°—æŠ•ç¥¨å±¥æ­´ã®æ¶ˆå»ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    } finally {
                        clearPopularityHistoryBtn.disabled = false;
                    }
                });
            });
            
            // Reset Jokers
            resetJokersBtn.addEventListener('click', () => {
                showConfirmationModal('æœ¬å½“ã«å…¨å“¡ã®JOKERã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ', async () => {
                    resetJokersBtn.disabled = true;
                    const batch = writeBatch(db);
                    MEMBERS.forEach(member => {
                        const jokerRef = doc(jokersCol, member.id);
                        batch.set(jokerRef, { count: 1, lastUsed: new Date(0) });
                    });
                    await batch.commit();
                    showModal('å…¨å“¡ã®JOKERãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸã€‚');
                    resetJokersBtn.disabled = false;
                });
            });

            // Wish button
            wishList.addEventListener('click', async (e) => {
                const target = e.target;
                const userId = target.dataset.id;
                if (!userId) return;

                const member = MEMBERS.find(m => m.id === userId);
                if (!member) return;
                
                const buttonContainer = target.parentElement;

                if (target.classList.contains('wish-btn') || target.classList.contains('joker-btn') || target.classList.contains('leftover-btn') || target.classList.contains('no-wish-btn')) {
                    buttonContainer.innerHTML = '<span class="text-sm text-gray-500">å‡¦ç†ä¸­...</span>';
                    
                    let status = 'not_wishing';
                    let jokerUsed = false;
                    if(target.classList.contains('wish-btn')) status = 'wishing';
                    if(target.classList.contains('joker-btn')) {
                        status = 'wishing';
                        jokerUsed = true;
                        const li = document.getElementById(`wish-item-${userId}`);
                        li.classList.add('joker-flash');
                        await new Promise(r => setTimeout(r, 1500));
                        const jokerRef = doc(jokersCol, userId);
                        await setDoc(jokerRef, { count: 0, lastUsed: new Date() }, { merge: true });
                    }
                    if(target.classList.contains('leftover-btn')) status = 'leftover';
                    if(target.classList.contains('no-wish-btn')) status = 'not_wishing';

                    await setDoc(doc(wishesCol, userId), {
                        name: member.name,
                        priority: member.priority,
                        status: status,
                        jokerUsed: jokerUsed,
                        timestamp: new Date()
                    });
                }
            });
            
            // Take bento button
            takersList.addEventListener('click', async (e) => {
                if (e.target.classList.contains('take-btn')) {
                    const takerId = e.target.dataset.id;
                    e.target.disabled = true;
                    
                    try {
                        await runTransaction(db, async (transaction) => {
                            const bentoSnap = await transaction.get(bentoDocRef);
                            const takerSnap = await transaction.get(doc(takersCol, takerId));
                            const statDocRef = doc(statsCol, takerId);
                            const statSnap = await transaction.get(statDocRef);

                            if (!bentoSnap.exists() || bentoSnap.data().current_stock <= 0) throw "å¼å½“ã®åœ¨åº«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
                            if (!takerSnap.exists() || takerSnap.data().taken) throw "ã™ã§ã«å—ã‘å–ã‚Šæ¸ˆã¿ã‹ã€å¯¾è±¡è€…ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";

                            transaction.update(bentoDocRef, { current_stock: bentoSnap.data().current_stock - 1 });
                            transaction.update(doc(takersCol, takerId), { taken: true });

                            const newTotal = (statSnap.exists() ? statSnap.data().total_taken : 0) + 1;
                            transaction.set(statDocRef, { total_taken: newTotal, name: takerSnap.data().name }, { merge: true });

                            const historyDocRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'history'));
                            transaction.set(historyDocRef, {
                                userId: takerId,
                                name: takerSnap.data().name,
                                bento_name: bentoSnap.data().name,
                                timestamp: new Date()
                            });
                        });
                    } catch (error) {
                        console.error("å—ã‘å–ã‚Šå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ", error);
                        showModal("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š" + error);
                    }
                }
            });
            
            // Replay button
            replayRouletteBtn.addEventListener('click', () => {
                if (currentBento && currentBento.lotteryCompleted) {
                    runLotteryProcess(currentBento.lotteryApplicants, currentBento.lotteryWinners, true);
                }
            });

            // Modal close
            customModal.addEventListener('click', (e) => {
                if (e.target === customModal) {
                    hideModal();
                }
            });
        }
        
        // --- Lottery Logic ---

        function selectWinners(applicants, count) {
            let currentApplicants = [...applicants];
            let winners = [];
            for (let i = 0; i < count; i++) {
                 let weightedApplicants = currentApplicants.map(p => {
                    const wish = wishes.get(p.id);
                    const weight = wish && wish.jokerUsed ? p.weight * 10 : p.weight;
                    return {...p, finalWeight: weight};
                 });

                const totalWeight = weightedApplicants.reduce((sum, p) => sum + p.finalWeight, 0);
                if (totalWeight === 0) break;
                
                let random = Math.random() * totalWeight;
                for (const applicant of weightedApplicants) {
                    random -= applicant.finalWeight;
                    if (random < 0) {
                        winners.push(applicant);
                        currentApplicants = currentApplicants.filter(p => p.id !== applicant.id);
                        break;
                    }
                }
            }
            return winners;
        }

        async function runLotteryProcess(applicants, preselectedWinners, isReplay = false) {
            if (isLotteryRunning) return;
            isLotteryRunning = true;

            lotteryModal.classList.remove('hidden');
            lotteryTitle.textContent = isReplay ? 'æŠ½é¸çµæœã®å†ç”Ÿ' : 'é‹å‘½ã®æŠ½é¸ï¼';
            if (replayRouletteBtn) replayRouletteBtn.disabled = true;

            // 1. Create cards
            lotteryCards.innerHTML = '';
            applicants.forEach(applicant => {
                const card = document.createElement('div');
                card.id = `card-${applicant.id}`;
                card.className = 'lottery-card';
                card.innerHTML = `
                    <div class="lottery-card-inner">
                        <div class="lottery-card-front">?</div>
                        <div class="lottery-card-back">
                            <span class="font-bold text-lg">${applicant.name}</span>
                            <span id="result-${applicant.id}" class="text-sm font-medium"></span>
                        </div>
                    </div>
                `;
                lotteryCards.appendChild(card);
            });
            
            // 2. Shuffle animation
            lotteryMessage.textContent = 'ã‚·ãƒ£ãƒƒãƒ•ãƒ«ä¸­...';
            const cards = Array.from(lotteryCards.children);
            await new Promise(r => setTimeout(r, 100)); // allow cards to render
            for(let i=0; i<3; i++) {
                 await new Promise(r => setTimeout(r, 300));
                 cards.sort(() => Math.random() - 0.5);
                 cards.forEach(card => lotteryCards.appendChild(card));
            }
            await new Promise(r => setTimeout(r, 500));

            // 3. Reveal winners
            for (let i = 0; i < preselectedWinners.length; i++) {
                const winner = preselectedWinners[i];
                lotteryMessage.textContent = `${i + 1}äººç›®ã®å½“é¸è€…ã¯...`;
                await new Promise(r => setTimeout(r, 1500));
                
                const winnerCard = document.getElementById(`card-${winner.id}`);
                winnerCard.classList.add('flipped', 'winner-card');
                winnerCard.style.transform = 'scale(1.1)';
                document.getElementById(`result-${winner.id}`).textContent = 'ğŸ‰ å½“é¸ ğŸ‰';
            }

            // 4. Reveal others
            lotteryMessage.textContent = 'çµæœç™ºè¡¨ï¼';
            await new Promise(r => setTimeout(r, 1000));
            applicants.forEach(applicant => {
                const isWinner = preselectedWinners.some(w => w.id === applicant.id);
                if (!isWinner) {
                    const card = document.getElementById(`card-${applicant.id}`);
                    card.classList.add('flipped');
                     document.getElementById(`result-${applicant.id}`).textContent = 'æ®‹å¿µ...';
                }
            });

            // 5. Clean up
            await new Promise(r => setTimeout(r, 4000));
            lotteryModal.classList.add('hidden');
            if(replayRouletteBtn) replayRouletteBtn.disabled = false;
            
            if (!isReplay) {
                await saveTakers(applicants, preselectedWinners);
            }
            isLotteryRunning = false;
        }
        
        async function saveTakers(applicants, winners) {
            try {
                const batch = writeBatch(db);
                winners.forEach(taker => {
                    const member = MEMBERS.find(m => m.id === taker.id);
                    if (member) {
                        batch.set(doc(takersCol, member.id), {
                            name: member.name,
                            priority: member.priority,
                            taken: false,
                            timestamp: new Date()
                        });
                    }
                });
                
                const lotteryResult = {
                    lotteryCompleted: true,
                    lotteryApplicants: applicants.map(a => ({ id: a.id, name: a.name })), 
                    lotteryWinners: winners.map(w => ({ id: w.id, name: w.name }))
                };
                batch.update(bentoDocRef, lotteryResult);

                await batch.commit();

            } catch (error) {
                console.error("ç¢ºå®šè€…ã®æ›¸ãè¾¼ã¿ã«å¤±æ•—:", error);
                showModal("ç¢ºå®šè€…ã®æ±ºå®šå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
            } finally {
                determinationInProgress = false; 
            }
        }

        // --- ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯ ---
        async function determineTakers() {
            if (determinationInProgress || !currentBento || currentBento.lotteryCompleted) {
                return;
            }

            const totalVotes = wishes.size;
            const totalMembers = MEMBERS.length;

            if (totalVotes === totalMembers) {
                determinationInProgress = true;
                
                systemMessage.textContent = 'å…¨å“¡ã®æ„æ€è¡¨ç¤ºãŒå®Œäº†ã—ã¾ã—ãŸã€‚æŠ½é¸å‡¦ç†ä¸­ã§ã™...';
                systemMessage.classList.replace('bg-yellow-100', 'bg-green-100');
                systemMessage.classList.replace('text-yellow-800', 'text-green-800');

                const stock = currentBento.initial_stock;
                let finalTakers = [];

                const wishingMembers = Array.from(wishes.values())
                    .filter(w => w.status === 'wishing')
                    .map(wisher => MEMBERS.find(m => m.priority === wisher.priority))
                    .sort((a, b) => a.priority - b.priority);

                const leftoverMembers = Array.from(wishes.values())
                    .filter(w => w.status === 'leftover')
                    .map(wisher => MEMBERS.find(m => m.priority === wisher.priority))
                    .sort((a, b) => a.priority - b.priority);

                if (wishingMembers.length === 0 && leftoverMembers.length === 0) {
                     await updateDoc(bentoDocRef, { lotteryCompleted: true });
                     determinationInProgress = false;
                     return;
                }
                
                if (wishingMembers.length >= stock) {
                    // Lottery among wishing members
                    const winners = selectWinners(wishingMembers, stock);
                    runLotteryProcess(wishingMembers, winners);
                } else {
                    // All wishing members get a bento
                    finalTakers = [...wishingMembers];
                    let remainingStock = stock - wishingMembers.length;

                    if (remainingStock > 0 && leftoverMembers.length > 0) {
                        if (leftoverMembers.length <= remainingStock) {
                            // All leftover members get a bento
                            finalTakers.push(...leftoverMembers);
                        } else {
                            // Lottery among leftover members for remaining stock
                            const leftoverWinners = selectWinners(leftoverMembers, remainingStock);
                            finalTakers.push(...leftoverWinners);
                            // No lottery animation for leftovers to keep it simple
                        }
                    }
                    await saveTakers(wishingMembers.concat(leftoverMembers), finalTakers);
                }
            } else if (currentBento && totalVotes >= 0) {
                const remainingVotes = totalMembers - totalVotes;
                 if (remainingVotes > 0) {
                    systemMessage.textContent = `ã‚ã¨${remainingVotes}äººã®æ„æ€è¡¨ç¤ºå¾…ã¡ã§ã™...`;
                    systemMessage.classList.replace('bg-green-100', 'bg-yellow-100');
                    systemMessage.classList.replace('text-green-800', 'text-yellow-800');
                }
            }
        }

        // --- åˆæœŸåŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
             // DOMè¦ç´ ã®åˆæœŸåŒ–
            userTab = document.getElementById('user-tab');
            adminTab = document.getElementById('admin-tab');
            userView = document.getElementById('user-view');
            adminView = document.getElementById('admin-view');
            bentoNameInput = document.getElementById('bento-name');
            bentoStockInput = document.getElementById('bento-stock');
            registerBentoBtn = document.getElementById('register-bento-btn');
            clearPopularityHistoryBtn = document.getElementById('clear-popularity-history-btn');
            resetJokersBtn = document.getElementById('reset-jokers-btn');
            currentBentoName = document.getElementById('current-bento-name');
            currentBentoStock = document.getElementById('current-bento-stock');
            wishList = document.getElementById('wish-list');
            adminWishList = document.getElementById('admin-wish-list');
            takersList = document.getElementById('takers-list');
            statsList = document.getElementById('stats-list');
            historyList = document.getElementById('history-list');
            bentoHistoryTableBody = document.getElementById('bento-history-table-body');
            adminBentoHistoryTableBody = document.getElementById('admin-bento-history-table-body');
            systemMessage = document.getElementById('system-message');
            bentoInfoCard = document.getElementById('bento-info-card');
            replayRouletteBtn = document.getElementById('replay-roulette-btn');
            jokerStatusList = document.getElementById('joker-status-list');
            customModal = document.getElementById('custom-modal');
            modalContent = document.getElementById('modal-content');
            modalTitle = document.getElementById('modal-title');
            modalMessage = document.getElementById('modal-message');
            modalButtons = document.getElementById('modal-buttons');
            modalIconContainer = document.getElementById('modal-icon-container');
            passcodeModal = document.getElementById('passcode-modal');
            passcodeInput = document.getElementById('passcode-input');
            passcodeError = document.getElementById('passcode-error');
            passcodeSubmitBtn = document.getElementById('passcode-submit-btn');
            passcodeCancelBtn = document.getElementById('passcode-cancel-btn');
            lotteryModal = document.getElementById('lottery-modal');
            lotteryTitle = document.getElementById('lottery-title');
            lotteryMessage = document.getElementById('lottery-message');
            lotteryCards = document.getElementById('lottery-cards');

            setupEventListeners();
            setupRealtimeListeners();
        });

    </script>
</body>
</html>
